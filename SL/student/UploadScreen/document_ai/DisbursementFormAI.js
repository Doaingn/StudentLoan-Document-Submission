// documents_ai/DisbursementFormAI.js - Enhanced with profile data verification and term validation
import { GoogleGenerativeAI } from "@google/generative-ai";
import * as FileSystem from "expo-file-system/legacy";
import { Alert } from "react-native";
import { doc, getDoc } from "firebase/firestore";
import { db, auth } from "../../../database/firebase";

// Configuration
const GEMINI_API_KEY = process.env.EXPO_PUBLIC_GEMINI_API_KEY;

let genAI = null;
let model = null;

console.log("üîß DisbursementFormAI Configuration:");
console.log("- Client-side only (no backend server)");
console.log("- API Key configured:", !!GEMINI_API_KEY);

// Initialize Gemini AI
const initializeGemini = () => {
  if (
    !genAI &&
    GEMINI_API_KEY &&
    GEMINI_API_KEY !== "YOUR_GEMINI_API_KEY_HERE"
  ) {
    try {
      genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
      model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
      console.log("‚úì Gemini AI initialized successfully for DisbursementForm");
      return true;
    } catch (error) {
      console.error(
        "Failed to initialize Gemini AI for DisbursementForm:",
        error
      );
      return false;
    }
  }
  return !!genAI;
};

// Fetch current submission period config from Firebase
export const fetchCurrentSubmissionPeriod = async () => {
  try {
    console.log("üì• Fetching current submission period from Firebase...");
    const configDoc = await getDoc(doc(db, "DocumentService", "config"));

    if (!configDoc.exists()) {
      console.warn("‚ö†Ô∏è Config document not found");
      return null;
    }

    const configData = configDoc.data();
    console.log("‚úÖ Submission period config fetched:", configData);

    return {
      term: configData.term || null,
      academicYear: configData.academicYear || null,
      isEnabled: configData.isEnabled || false,
      immediateAccess: configData.immediateAccess || false,
    };
  } catch (error) {
    console.error("‚ùå Error fetching submission period config:", error);
    return null;
  }
};

// Fetch user profile data from Firebase
export const fetchUserProfileData = async () => {
  try {
    const user = auth.currentUser;
    if (!user) {
      console.warn("‚ö†Ô∏è No authenticated user found");
      return null;
    }

    console.log("üì• Fetching user profile data from Firebase...");
    const userDoc = await getDoc(doc(db, "users", user.uid));

    if (!userDoc.exists()) {
      console.warn("‚ö†Ô∏è User document not found");
      return null;
    }

    const userData = userDoc.data();
    console.log("‚úÖ User profile data fetched successfully");

    return {
      name: userData.name || null,
      student_id: userData.student_id || null,
      citizen_id: userData.citizen_id || null,
      birth_date: userData.birth_date || null,
      school: userData.school || null,
      major: userData.major || null,
      phone_num: userData.phone_num || null,
      email: userData.email || null,
    };
  } catch (error) {
    console.error("‚ùå Error fetching user profile data:", error);
    return null;
  }
};

// Extract term number from text
const extractTermNumber = (text) => {
  if (!text) return null;

  const normalized = text.toString().toLowerCase();

  const trimmedText = text.toString().trim();
  if (/^[123]$/.test(trimmedText)) {
    return trimmedText;
  }
  //

  // Try to find term number patterns
  const patterns = [
    /‡∏†‡∏≤‡∏Ñ(?:‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)?(?:‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)?(?:‡∏ó‡∏µ‡πà)?\s*(\d+)/,
    /semester\s*(\d+)/i,
    /term\s*(\d+)/i,
    /‡πÄ‡∏ó‡∏≠‡∏°\s*(\d+)/,
    /‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà\s*(\d+)/,
  ];

  for (const pattern of patterns) {
    const match = normalized.match(pattern);
    if (match) {
      return match[1];
    }
  }

  // Check for standalone numbers after specific keywords
  if (normalized.includes("‡∏†‡∏≤‡∏Ñ") || normalized.includes("‡πÄ‡∏ó‡∏≠‡∏°")) {
    const numbers = text.match(/\d+/g);
    if (numbers && numbers.length > 0) {
      const num = numbers[0];
      if (num === "1" || num === "2" || num === "3") {
        return num;
      }
    }
  }

  return null;
};

// Extract academic year from text
const extractAcademicYear = (text) => {
  if (!text) return null;

  const normalized = text.toString();

  // Try to find academic year patterns
  const patterns = [
    /‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤\s*(\d{4})/,
    /(\d{4})\s*-\s*\d{4}/, // 2567-2568 format
    /academic\s*year\s*(\d{4})/i,
  ];

  for (const pattern of patterns) {
    const match = normalized.match(pattern);
    if (match) {
      return match[1];
    }
  }

  // Find any 4-digit year (25XX format for Thai Buddhist calendar)
  const yearMatch = normalized.match(/25\d{2}/);
  if (yearMatch) {
    return yearMatch[0];
  }

  return null;
};

// Compare extracted data with profile data and submission period
const compareWithProfile = (
  extractedData,
  profileData,
  submissionPeriod = null
) => {
  if (!profileData || !extractedData) {
    return {
      matchStatus: "no_profile_data",
      matches: {},
      mismatches: [],
      warnings: ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö"],
      termCheckResult: null,
    };
  }

  const matches = {};
  const mismatches = [];
  const warnings = [];
  let termCheckResult = null;

  // Helper function to normalize text
  const normalizeText = (text) => {
    if (!text) return "";
    return text
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .replace(/[^\u0E00-\u0E7Fa-z0-9\s]/g, "");
  };

  // Helper function to extract numbers
  const extractNumbers = (text) => {
    if (!text) return "";
    return text.toString().replace(/\D/g, "");
  };

  // ‚úÖ Check term and academic year if submission period is provided
  if (
    submissionPeriod &&
    submissionPeriod.term &&
    submissionPeriod.academicYear
  ) {
    const docTerm = extractTermNumber(extractedData.semester);
    const docYear = extractAcademicYear(extractedData.academic_year);

    console.log("üîç Term Validation:", {
      expectedTerm: submissionPeriod.term,
      extractedTerm: docTerm,
      expectedYear: submissionPeriod.academicYear,
      extractedYear: docYear,
    });

    const termMatches = docTerm === String(submissionPeriod.term);
    const yearMatches = docYear === String(submissionPeriod.academicYear);

    termCheckResult = {
      termMatches,
      yearMatches,
      expectedTerm: submissionPeriod.term,
      expectedYear: submissionPeriod.academicYear,
      extractedTerm: docTerm,
      extractedYear: docYear,
      overall: termMatches && yearMatches,
    };

    if (!termMatches || !yearMatches) {
      let mismatchMsg = "";
      if (!termMatches && !yearMatches) {
        mismatchMsg = `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${
          docTerm || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
        } ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${docYear || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"} ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${
          submissionPeriod.term
        } ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${submissionPeriod.academicYear}`;
      } else if (!termMatches) {
        mismatchMsg = `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${
          docTerm || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
        } ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${submissionPeriod.term}`;
      } else if (!yearMatches) {
        mismatchMsg = `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${
          docYear || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
        } ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${submissionPeriod.academicYear}`;
      }

      mismatches.push({
        field: "‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
        extracted: `‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${docTerm || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${
          docYear || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
        }`,
        profile: `‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${submissionPeriod.term} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${submissionPeriod.academicYear}`,
        reason: mismatchMsg,
        severity: "critical",
      });
    } else {
      matches.term = true;
      matches.academicYear = true;
    }
  }

  // Compare student name
  if (extractedData.studentName && profileData.name) {
    const extractedName = normalizeText(extractedData.studentName);
    const profileName = normalizeText(profileData.name);

    if (extractedName === profileName) {
      matches.name = true;
    } else if (
      extractedName.includes(profileName) ||
      profileName.includes(extractedName)
    ) {
      matches.name = true;
      warnings.push("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
    } else {
      matches.name = false;
      mismatches.push({
        field: "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
        extracted: extractedData.studentName,
        profile: profileData.name,
      });
    }
  }

  // Compare student ID
  if (extractedData.studentId && profileData.student_id) {
    const extractedId = extractNumbers(extractedData.studentId);
    const profileId = extractNumbers(profileData.student_id);

    if (extractedId === profileId) {
      matches.student_id = true;
    } else {
      matches.student_id = false;
      mismatches.push({
        field: "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
        extracted: extractedData.studentId,
        profile: profileData.student_id,
      });
    }
  }

  // Compare citizen ID
  if (extractedData.idNumber && profileData.citizen_id) {
    const extractedCitizenId = extractNumbers(extractedData.idNumber);
    const profileCitizenId = extractNumbers(profileData.citizen_id);

    if (extractedCitizenId === profileCitizenId) {
      matches.citizen_id = true;
    } else {
      matches.citizen_id = false;
      mismatches.push({
        field: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",
        extracted: extractedData.idNumber,
        profile: profileData.citizen_id,
      });
    }
  }

  // Compare university/school
  if (extractedData.university && profileData.school) {
    const extractedUni = normalizeText(extractedData.university);
    const profileSchool = normalizeText(profileData.school);

    const isUniversityName =
      extractedUni.includes("‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢") ||
      extractedUni.includes("university");

    if (!isUniversityName) {
      if (
        extractedUni.includes(profileSchool) ||
        profileSchool.includes(extractedUni)
      ) {
        matches.school = true;
      }
    }
  }

  // Compare faculty
  if (extractedData.faculty && profileData.school) {
    const extractedFaculty = normalizeText(extractedData.faculty);
    const profileSchool = normalizeText(profileData.school);

    if (
      extractedFaculty.includes(profileSchool) ||
      profileSchool.includes(extractedFaculty)
    ) {
      matches.school = true;
    } else {
      matches.school = false;
      mismatches.push({
        field: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤/‡∏Ñ‡∏ì‡∏∞",
        extracted: extractedData.faculty,
        profile: profileData.school,
      });
    }
  }

  // Determine overall match status
  let matchStatus = "full_match";

  // Check for critical term mismatch first
  const hasTermMismatch = mismatches.some((m) => m.severity === "critical");

  if (hasTermMismatch) {
    matchStatus = "term_mismatch";
  } else if (mismatches.length > 0) {
    matchStatus = "mismatch";
  } else if (warnings.length > 0) {
    matchStatus = "partial_match";
  } else if (Object.keys(matches).length === 0) {
    matchStatus = "insufficient_data";
    warnings.push("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö");
  }

  return {
    matchStatus,
    matches,
    mismatches,
    warnings,
    termCheckResult,
    comparisonDetails: {
      fieldsCompared: Object.keys(matches).length,
      fieldsMatched: Object.values(matches).filter((v) => v === true).length,
      fieldsMismatched: mismatches.length,
    },
  };
};

// Prepare file for Gemini
const prepareFileForGemini = async (fileUri, mimeType) => {
  try {
    console.log("üìÅ Preparing DisbursementForm file for Gemini AI...");

    const base64Data = await FileSystem.readAsStringAsync(fileUri, {
      encoding: FileSystem.EncodingType.Base64,
    });

    let actualMimeType = mimeType || "image/jpeg";
    if (!mimeType) {
      const ext = fileUri.split(".").pop()?.toLowerCase();
      if (ext === "png") actualMimeType = "image/png";
      else if (ext === "pdf") actualMimeType = "application/pdf";
    }

    console.log("‚úÖ DisbursementForm file prepared for Gemini");
    return {
      inlineData: {
        data: base64Data,
        mimeType: actualMimeType,
      },
    };
  } catch (error) {
    console.error("‚ùå Error preparing DisbursementForm file:", error);
    throw new Error(
      `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ: ${error.message}`
    );
  }
};

// Client-side validation
const validateDisbursementFormClientSide = async (
  fileUri,
  mimeType,
  profileData,
  submissionPeriod
) => {
  console.log("ü§ñ Starting client-side disbursement form validation...");

  if (!model) {
    const initialized = initializeGemini();
    if (!initialized) throw new Error("‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  }

  const filePart = await prepareFileForGemini(fileUri, mimeType);

  let profileInfo = "";
  if (profileData) {
    profileInfo = `

**‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:**
- ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: ${profileData.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}
- ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${profileData.student_id || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}
- ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${profileData.citizen_id || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}
- ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤: ${profileData.school || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}
- ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤: ${profileData.major || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢`;
  }

  let submissionPeriodInfo = "";
  if (submissionPeriod) {
    submissionPeriodInfo = `

**‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö:**
- ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà: ${submissionPeriod.term}
- ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${submissionPeriod.academicYear}

‚ö†Ô∏è **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å:** ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${submissionPeriod.term} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${submissionPeriod.academicYear} ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`;
  }

  const prompt = `
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏° (Disbursement Form) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
${profileInfo}
${submissionPeriodInfo}

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
{
  "isDisbursementForm": true/false,
  "confidence": 0-100,
  "documentType": "‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°/‡πÉ‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
  "loanType": "‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°/‡∏ó‡∏∏‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏ó‡∏∏‡∏ô‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê/‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
  "hasOfficialSeal": true/false,
  "hasSignature": true/false,
  "signatureQuality": "clear/unclear/missing",
  "hasStudentSignature": true/false,
  "extractedData": {
    "studentName": "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
    "studentId": "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
    "idNumber": "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",
    "loanAmount": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ",
    "disbursementAmount": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å",
    "academic_year": "‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
    "semester": "‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
    "university": "‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
    "faculty": "‡∏Ñ‡∏ì‡∏∞",
    "program": "‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤",
    "disbursementDate": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô",
    "issueDate": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£",
    "bankAccount": "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£",
    "bankName": "‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£",
    "officerName": "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á",
    "officerPosition": "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà",
    "referenceNumber": "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á"
  },
  "loanDetails": {
    "purpose": "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ",
    "repaymentPeriod": "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞",
    "interestRate": "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢",
    "guarantor": "‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô",
    "totalLoanAmount": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    "remainingAmount": "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠"
  },
  "documentQuality": {
    "isExpired": true/false/null,
    "isLegible": true/false,
    "hasWatermark": true/false,
    "imageQuality": "clear/blurry/poor/excellent",
    "isComplete": true/false
  },
  "validityChecks": {
    "hasValidDates": true/false,
    "hasConsistentInfo": true/false,
    "hasRequiredFields": true/false,
    "hasValidAmount": true/false,
    "isOfficialDocument": true/false
  },
  "qualityIssues": ["‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö"],
  "recommendations": ["‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"],
  "overall_status": "valid/invalid/needs_review"
}

‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö:
1. ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏à‡∏£‡∏¥‡∏á
2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô) - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
3. ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î! ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ
   - ‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "1/2568" ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏™‡πà "1" ‡πÉ‡∏ô field 'semester' ‡πÅ‡∏•‡∏∞ "2568" ‡πÉ‡∏ô field 'academic_year'
   - ‡∏´‡πâ‡∏≤‡∏°‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤ "1/2568" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô field ‡πÉ‡∏î field ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
4. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ
5. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
6. ‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
7. ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
8. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
9. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
`;

  try {
    const result = await model.generateContent([prompt, filePart]);
    const response = await result.response;
    const responseText = response.text();

    console.log("ü§ñ DisbursementForm AI Response received");

    let parsed;
    try {
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        parsed = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("No JSON found");
      }
    } catch (parseError) {
      console.warn("‚ö†Ô∏è Failed to parse JSON, using text analysis");
      parsed = analyzeDisbursementFormTextResponse(responseText);
    }

    // Add profile comparison with submission period
    if (profileData) {
      const comparison = compareWithProfile(
        parsed.extractedData,
        profileData,
        submissionPeriod
      );
      parsed.profileComparison = comparison;

      // Check for term mismatch (highest priority)
      const hasTermMismatch = comparison.mismatches.some(
        (m) => m.severity === "critical"
      );

      if (hasTermMismatch) {
        parsed.qualityIssues = parsed.qualityIssues || [];
        const termMismatch = comparison.mismatches.find(
          (m) => m.severity === "critical"
        );
        parsed.qualityIssues.unshift(`‚õî ${termMismatch.reason}`);

        parsed.recommendations = parsed.recommendations || [];
        parsed.recommendations.unshift(
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö"
        );

        // Force status to invalid
        parsed.overall_status = "invalid";
        parsed.confidence = Math.min(parsed.confidence || 0, 30);
      } else if (comparison.mismatches.length > 0) {
        // Other mismatches
        parsed.qualityIssues = parsed.qualityIssues || [];
        comparison.mismatches.forEach((mismatch) => {
          parsed.qualityIssues.push(
            `${mismatch.field}‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£="${mismatch.extracted}" ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå="${mismatch.profile}"`
          );
        });

        parsed.recommendations = parsed.recommendations || [];
        parsed.recommendations.push(
          "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
        );

        if (parsed.overall_status === "valid") {
          parsed.overall_status = "needs_review";
        }
      }

      if (comparison.warnings.length > 0) {
        parsed.recommendations = parsed.recommendations || [];
        parsed.recommendations.push(...comparison.warnings);
      }
    }

    console.log("‚úÖ Client-side DisbursementForm validation completed");
    return parsed;
  } catch (error) {
    console.error("‚ùå Client-side validation failed:", error);
    throw error;
  }
};

// Fallback text analysis
const analyzeDisbursementFormTextResponse = (text) => {
  const lowerText = text.toLowerCase();

  const isDisbursementForm =
    lowerText.includes("‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô") ||
    lowerText.includes("‡πÉ‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô") ||
    lowerText.includes("disbursement") ||
    lowerText.includes("‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô") ||
    lowerText.includes("‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°") ||
    lowerText.includes("‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤");

  const hasOfficialSeal =
    lowerText.includes("‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö") ||
    lowerText.includes("‡∏ï‡∏£‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£") ||
    lowerText.includes("official seal");

  const hasSignature =
    lowerText.includes("‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô") ||
    lowerText.includes("‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠") ||
    lowerText.includes("signature");

  let loanType = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  if (lowerText.includes("‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤")) loanType = "‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤";
  else if (lowerText.includes("‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°")) loanType = "‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°";
  else if (lowerText.includes("‡∏Å‡∏¢‡∏®")) loanType = "‡∏ó‡∏∏‡∏ô‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê";

  return {
    isDisbursementForm,
    confidence: isDisbursementForm ? 75 : 25,
    documentType: isDisbursementForm ? "‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°" : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    loanType,
    hasOfficialSeal,
    hasSignature,
    signatureQuality: hasSignature ? "unclear" : "missing",
    hasStudentSignature: hasSignature,
    issuingAuthority: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    extractedData: {},
    loanDetails: {},
    documentQuality: {
      isExpired: null,
      isLegible: true,
      hasWatermark: false,
      imageQuality: "unclear",
      isComplete: true,
    },
    validityChecks: {
      hasValidDates: null,
      hasConsistentInfo: null,
      hasRequiredFields: isDisbursementForm,
      hasValidAmount: null,
      isOfficialDocument: hasOfficialSeal,
    },
    qualityIssues: !isDisbursementForm
      ? ["‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°"]
      : [],
    recommendations: !isDisbursementForm
      ? ["‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°"]
      : [],
    overall_status:
      isDisbursementForm && hasOfficialSeal && hasSignature
        ? "valid"
        : "needs_review",
    rawResponse: text,
  };
};

// Main validation function
export const validateDisbursementForm = async (
  fileUri,
  mimeType = null,
  includeProfileCheck = true,
  includeTermCheck = true
) => {
  try {
    console.log("üöÄ Starting disbursement form validation...");

    const fileInfo = await FileSystem.getInfoAsync(fileUri);
    if (!fileInfo.exists) {
      throw new Error("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏û‡∏ö");
    }

    // Fetch profile data if requested
    let profileData = null;
    if (includeProfileCheck) {
      profileData = await fetchUserProfileData();
      if (profileData) {
        console.log("‚úÖ Profile data loaded for comparison");
      }
    }

    // Fetch submission period if requested
    let submissionPeriod = null;
    if (includeTermCheck) {
      submissionPeriod = await fetchCurrentSubmissionPeriod();
      if (
        submissionPeriod &&
        submissionPeriod.term &&
        submissionPeriod.academicYear
      ) {
        console.log("‚úÖ Submission period loaded:", submissionPeriod);
      } else {
        console.warn("‚ö†Ô∏è Submission period not configured");
      }
    }

    console.log("‚úÖ Using client-side DisbursementForm validation");
    return await validateDisbursementFormClientSide(
      fileUri,
      mimeType,
      profileData,
      submissionPeriod
    );
  } catch (error) {
    console.error("‚ùå DisbursementForm validation error:", error);
    throw new Error(`‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
  }
};

// Parse result
export const parseDisbursementFormResult = (result) => {
  if (!result) return null;

  const hasTermMismatch =
    result.profileComparison?.matchStatus === "term_mismatch";

  return {
    isValid:
      result.overall_status === "valid" &&
      result.isDisbursementForm &&
      !hasTermMismatch &&
      result.profileComparison?.matchStatus !== "mismatch",
    confidence: result.confidence || 0,
    status: result.overall_status || "unknown",
    documentType: result.documentType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    loanType: result.loanType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    hasOfficialSeal: result.hasOfficialSeal || false,
    hasSignature: result.hasSignature || false,
    hasStudentSignature: result.hasStudentSignature || false,
    signatureQuality: result.signatureQuality || "missing",
    issuingAuthority: result.issuingAuthority || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    extractedData: result.extractedData || {},
    loanDetails: result.loanDetails || {},
    documentQuality: result.documentQuality || {},
    validityChecks: result.validityChecks || {},
    profileComparison: result.profileComparison || null,
    qualityIssues: result.qualityIssues || [],
    recommendations: result.recommendations || [],
    hasTermMismatch: hasTermMismatch,
    rawResult: result,
  };
};

// Show validation alert
export const showDisbursementFormValidationAlert = (
  result,
  onAccept,
  onReject
) => {
  let title, message;

  const hasTermMismatch =
    result.profileComparison?.matchStatus === "term_mismatch";
  const profileMismatch = result.profileComparison?.matchStatus === "mismatch";

  if (hasTermMismatch) {
    title = "‚õî ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö";
  } else if (profileMismatch) {
    title = "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå";
  } else if (result.overall_status === "valid") {
    title = "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  } else {
    title = "‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
  }

  let statusText = "";
  statusText += result.isDisbursementForm
    ? "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°\n"
    : "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°\n";

  if (result.loanType && result.loanType !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    statusText += `üí∞ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ: ${result.loanType}\n`;
  }

  statusText += result.hasOfficialSeal
    ? "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô\n"
    : "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô\n";
  statusText += result.hasStudentSignature
    ? `‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (${result.signatureQuality})\n`
    : "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤\n";
  statusText += result.hasSignature
    ? "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà\n"
    : "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà\n";

  statusText += `\nüéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô: ${result.confidence}%`;
  statusText += `\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${result.documentType}`;

  if (result.issuingAuthority && result.issuingAuthority !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    statusText += `\n‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å: ${result.issuingAuthority}`;
  }

  // Term check result
  if (result.profileComparison?.termCheckResult) {
    const termCheck = result.profileComparison.termCheckResult;
    statusText += "\n\nüìÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:\n";

    if (hasTermMismatch) {
      statusText += `‚õî ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${
        termCheck.extractedTerm || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
      } ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.extractedYear || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\n`;
      statusText += `‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${termCheck.expectedTerm} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.expectedYear}\n`;
      statusText += "\n‚ùå ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ";
    } else if (termCheck.overall) {
      statusText += `‚úÖ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö (‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${termCheck.expectedTerm} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.expectedYear})`;
    }
  }

  // Profile comparison
  if (result.profileComparison && !hasTermMismatch) {
    const comp = result.profileComparison;
    statusText += "\n\nüë§ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:\n";

    if (comp.matchStatus === "full_match") {
      statusText += "‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£\n";
    } else if (comp.matchStatus === "partial_match") {
      statusText += "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô\n";
    } else if (comp.matchStatus === "mismatch") {
      statusText += "‚ùå ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô:\n";
      comp.mismatches.forEach((m) => {
        if (m.severity !== "critical") {
          statusText += `  ‚Ä¢ ${m.field}\n`;
          statusText += `    ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${m.extracted}\n`;
          statusText += `    ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ${m.profile}\n`;
        }
      });
    }

    if (comp.comparisonDetails) {
      statusText += `\n‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö: ${comp.comparisonDetails.fieldsMatched}/${comp.comparisonDetails.fieldsCompared} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
    }
  }

  if (result.extractedData && Object.keys(result.extractedData).length > 0) {
    statusText += "\n\nüìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö:";
    if (result.extractedData.studentName)
      statusText += `\n‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠: ${result.extractedData.studentName}`;
    if (result.extractedData.studentId)
      statusText += `\n‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${result.extractedData.studentId}`;
    if (result.extractedData.disbursementAmount)
      statusText += `\n‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${result.extractedData.disbursementAmount}`;
    if (result.extractedData.academic_year)
      statusText += `\n‚Ä¢ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${result.extractedData.academic_year}`;
    if (result.extractedData.semester)
      statusText += `\n‚Ä¢ ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${result.extractedData.semester}`;
  }

  if (result.qualityIssues?.length > 0) {
    statusText += "\n\n‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:\n‚Ä¢ " + result.qualityIssues.join("\n‚Ä¢ ");
  }

  if (result.recommendations?.length > 0) {
    statusText += "\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n‚Ä¢ " + result.recommendations.join("\n‚Ä¢ ");
  }

  message = statusText;

  const isValid =
    result.overall_status === "valid" &&
    result.isDisbursementForm &&
    !hasTermMismatch &&
    !profileMismatch;

  const buttons = [
    {
      text: "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà",
      style: "cancel",
      onPress: onReject,
    },
  ];

  if (hasTermMismatch) {
    // Only show OK button for term mismatch - cannot use this document
    buttons.push({
      text: "‡∏ï‡∏Å‡∏•‡∏á",
      style: "default",
      onPress: onReject,
    });
  } else if (profileMismatch) {
    buttons.push({
      text: "‡∏ï‡∏Å‡∏•‡∏á",
      style: "default",
      onPress: onReject,
    });
  } else if (isValid || result.overall_status === "needs_review") {
    buttons.push({
      text:
        result.overall_status === "valid"
          ? "‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ"
          : "‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)",
      onPress: () => onAccept(result),
    });
  }

  Alert.alert(title, message, buttons);
};

// Format data for database
export const formatDisbursementFormDataForDB = (
  result,
  documentType,
  fileName
) => {
  return {
    documentType: documentType,
    fileName: fileName,

    basicInfo: {
      isValid: result.isValid || false,
      confidence: result.confidence || 0,
      overall_status: result.overall_status || "unknown",
      documentType: result.documentType || "unknown",
      loanType: result.loanType || "unknown",
      issuingAuthority: result.issuingAuthority || "unknown",
    },

    signatureInfo: {
      hasOfficialSeal: result.hasOfficialSeal || false,
      hasSignature: result.hasSignature || false,
      hasStudentSignature: result.hasStudentSignature || false,
      signatureQuality: result.signatureQuality || "missing",
    },

    extractedData: {
      studentName: result.extractedData?.studentName || null,
      studentId: result.extractedData?.studentId || null,
      idNumber: result.extractedData?.idNumber || null,
      loanAmount: result.extractedData?.loanAmount || null,
      disbursementAmount: result.extractedData?.disbursementAmount || null,
      academic_year: result.extractedData?.academic_year || null,
      semester: result.extractedData?.semester || null,
      university: result.extractedData?.university || null,
      faculty: result.extractedData?.faculty || null,
      program: result.extractedData?.program || null,
      disbursementDate: result.extractedData?.disbursementDate || null,
      issueDate: result.extractedData?.issueDate || null,
      bankAccount: result.extractedData?.bankAccount || null,
      bankName: result.extractedData?.bankName || null,
      officerName: result.extractedData?.officerName || null,
      officerPosition: result.extractedData?.officerPosition || null,
      referenceNumber: result.extractedData?.referenceNumber || null,
    },

    loanDetails: result.loanDetails || {},
    documentQuality: result.documentQuality || {},
    validityChecks: result.validityChecks || {},

    profileComparison: result.profileComparison
      ? {
          matchStatus: result.profileComparison.matchStatus,
          matches: result.profileComparison.matches,
          mismatches: result.profileComparison.mismatches,
          warnings: result.profileComparison.warnings,
          comparisonDetails: result.profileComparison.comparisonDetails,
          termCheckResult: result.profileComparison.termCheckResult || null,
        }
      : null,

    qualityIssues: result.qualityIssues || [],
    recommendations: result.recommendations || [],

    metadata: {
      validatedAt: new Date().toISOString(),
      aiModel: "gemini-2.0-flash",
      profileCheckEnabled: !!result.profileComparison,
      termCheckEnabled: !!result.profileComparison?.termCheckResult,
    },
  };
};

// Check requirements
export const checkDisbursementFormRequirements = (result) => {
  if (!result) return { passed: false, issues: ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"] };

  const issues = [];

  if (!result.isDisbursementForm)
    issues.push("‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°");
  if (!result.hasOfficialSeal) issues.push("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô");
  if (!result.hasStudentSignature) issues.push("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤");
  if (!result.hasSignature) issues.push("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà");

  if (result.validityChecks) {
    if (!result.validityChecks.hasValidDates) issues.push("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    if (!result.validityChecks.hasRequiredFields)
      issues.push("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
    if (!result.validityChecks.hasValidAmount)
      issues.push("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    if (!result.validityChecks.isOfficialDocument)
      issues.push("‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£");
  }

  // Check for term/period mismatch
  const hasTermMismatch =
    result.profileComparison?.matchStatus === "term_mismatch";

  if (hasTermMismatch) {
    const termMismatch = result.profileComparison.mismatches.find(
      (m) => m.severity === "critical"
    );
    if (termMismatch) {
      issues.push(`‚õî ${termMismatch.reason}`);
    } else {
      issues.push(
        "‚õî ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö (‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ó‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î)"
      );
    }
  } else if (result.profileComparison?.matchStatus === "mismatch") {
    issues.push("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå");
  }

  return {
    passed: issues.length === 0,
    issues: issues,
    requirements: {
      isDisbursementForm: result.isDisbursementForm,
      hasOfficialSeal: result.hasOfficialSeal,
      hasSignatures: result.hasStudentSignature && result.hasSignature,
      validDocument: result.validityChecks?.isOfficialDocument,
      profileMatches: result.profileComparison?.matchStatus !== "mismatch",
      correctTerm: !hasTermMismatch,
    },
  };
};

// Generate summary
export const generateDisbursementFormSummary = (result) => {
  if (!result) return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö";

  const requirements = checkDisbursementFormRequirements(result);
  const hasTermMismatch =
    result.profileComparison?.matchStatus === "term_mismatch";

  let summary = `üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°\n\n`;
  summary += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${
    result.overall_status === "valid"
      ? "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô"
      : result.overall_status === "needs_review"
      ? "‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
      : "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"
  }\n`;
  summary += `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ: ${result.loanType}\n`;
  summary += `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô: ${result.confidence}%\n\n`;

  summary += `‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:\n`;
  summary += `${
    requirements.requirements.isDisbursementForm ? "‚úÖ" : "‚ùå"
  } ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°\n`;
  summary += `${
    requirements.requirements.hasOfficialSeal ? "‚úÖ" : "‚ùå"
  } ‡∏°‡∏µ‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô\n`;
  summary += `${
    requirements.requirements.hasSignatures ? "‚úÖ" : "‚ùå"
  } ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô\n`;
  summary += `${
    requirements.requirements.validDocument ? "‚úÖ" : "‚ùå"
  } ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£\n`;
  summary += `${
    requirements.requirements.profileMatches ? "‚úÖ" : "‚ùå"
  } ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå\n`;
  summary += `${
    requirements.requirements.correctTerm ? "‚úÖ" : "‚ùå"
  } ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö\n`;

  if (result.extractedData && Object.keys(result.extractedData).length > 0) {
    summary += `\nüìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:\n`;
    if (result.extractedData.studentName)
      summary += `‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠: ${result.extractedData.studentName}\n`;
    if (result.extractedData.studentId)
      summary += `‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${result.extractedData.studentId}\n`;
    if (result.extractedData.disbursementAmount)
      summary += `‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${result.extractedData.disbursementAmount}\n`;
    if (result.extractedData.academic_year)
      summary += `‚Ä¢ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${result.extractedData.academic_year}\n`;
    if (result.extractedData.semester)
      summary += `‚Ä¢ ‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${result.extractedData.semester}\n`;
  }

  if (result.profileComparison?.termCheckResult) {
    const termCheck = result.profileComparison.termCheckResult;
    summary += `\nüìÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:\n`;
    if (hasTermMismatch) {
      summary += `‚õî ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${
        termCheck.extractedTerm || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
      } ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.extractedYear || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}\n`;
      summary += `‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${termCheck.expectedTerm} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.expectedYear}\n`;
    } else if (termCheck.overall) {
      summary += `‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö (‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${termCheck.expectedTerm} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${termCheck.expectedYear})\n`;
    }
  }

  if (result.profileComparison && !hasTermMismatch) {
    summary += `\nüë§ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:\n`;
    const comp = result.profileComparison;
    if (comp.matchStatus === "full_match") {
      summary += `‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£\n`;
    } else if (comp.matchStatus === "mismatch") {
      summary += `‚ùå ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô:\n`;
      comp.mismatches.forEach((m) => {
        if (m.severity !== "critical") {
          summary += `  ‚Ä¢ ${m.field}: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£="${m.extracted}" ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå="${m.profile}"\n`;
        }
      });
    }
  }

  if (!requirements.passed) {
    summary += `\n‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:\n`;
    requirements.issues.forEach((issue) => {
      summary += `‚Ä¢ ${issue}\n`;
    });
  }

  return summary;
};

// Validate multiple forms
export const validateMultipleDisbursementForms = async (
  files,
  includeProfileCheck = true,
  includeTermCheck = true
) => {
  const results = [];

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    try {
      const result = await validateDisbursementForm(
        file.uri,
        file.mimeType,
        includeProfileCheck,
        includeTermCheck
      );
      const hasTermMismatch =
        result.profileComparison?.matchStatus === "term_mismatch";
      results.push({
        fileIndex: i,
        fileName: file.name || file.filename,
        validation: result,
        success: true,
        profileMatch: result.profileComparison?.matchStatus !== "mismatch",
        termMatch: !hasTermMismatch,
      });
    } catch (error) {
      results.push({
        fileIndex: i,
        fileName: file.name || file.filename,
        error: error.message,
        success: false,
        profileMatch: false,
        termMatch: false,
      });
    }
  }

  return results;
};

// Check AI status
export const checkDisbursementFormAIStatus = async () => {
  try {
    console.log("ü§ñ Checking DisbursementForm AI backend status...");

    if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
      return {
        available: false,
        error: "API key not configured",
      };
    }

    const initialized = initializeGemini();
    if (!initialized) {
      return {
        available: false,
        error: "Failed to initialize AI",
      };
    }

    try {
      const testResult = await model.generateContent(
        "Test connection - respond with OK"
      );
      const testResponse = await testResult.response;
      testResponse.text();

      return {
        available: true,
        method: "client",
        profileCheckEnabled: true,
        termCheckEnabled: true,
        config: {
          apiKey: "***configured***",
          model: "gemini-2.0-flash",
        },
      };
    } catch (testError) {
      return {
        available: false,
        error: testError.message,
      };
    }
  } catch (error) {
    return {
      available: false,
      error: error.message,
    };
  }
};
